<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Tax System 2026 - MULTI-USER</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { background-color: #d1d4d7; font-family: Arial, sans-serif; font-size: 10px; }
        #login-overlay, #home-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #d1d4d7; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-box, .home-box { background: #e0e0e0; padding: 25px; border: 1px solid #999; width: 85%; max-width: 950px; box-shadow: 4px 4px 15px rgba(0,0,0,0.3); }
        .form-container { background: #e0e0e0; padding: 10px 15px; border: 1px solid #999; margin: 5px auto; width: 99%; box-shadow: 2px 2px 10px rgba(0,0,0,0.2); display: none; }
        .form-label { font-weight: bold; font-size: 9px; text-transform: uppercase; margin-bottom: 1px; display: block; line-height: 1; }
        .form-control-sm { border-radius: 0; border: 1px solid #888; height: 22px; font-size: 10px; padding: 2px 5px; }
        .readonly-field { background-color: #f2f2f2 !important; font-weight: bold; }
        fieldset { border: 1px solid #999; padding: 8px; margin-top: 8px; background: #e9e9e9; }
        legend { width: auto; font-size: 10px; font-weight: bold; padding: 0 5px; color: #b22222; margin-bottom: 5px; float: none; }
        th { font-size: 8px; text-align: center; background: #ccc !important; border: 1px solid #999; text-transform: uppercase; padding: 4px !important; }
        td { padding: 2px !important; vertical-align: middle; }
        .section-total-header { background: #fff; border: 2px solid #333; font-weight: bold; color: #b22222; height: 28px; font-size: 13px; width: 150px; }
        .balance-box { background: #fff; border: 2px solid #28a745; color: #28a745; font-size: 16px; height: 38px; font-weight: bold; }
        .remarks-area { height: 75px !important; resize: none; font-weight: bold; color: #0b2447; background-color: #ffeb3b !important; border: 1px solid #999; }
        .building-section { display: none; border-top: 3px double #999; margin-top: 15px; padding-top: 10px; }
        @media print { .d-print-none, .btn, #login-overlay, #home-screen { display: none !important; } .form-container { border: none; box-shadow: none; width: 100%; background: white !important; display: block !important; } }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box" style="max-width:350px;">
        <h6 class="text-center fw-bold mb-3" style="color:#b22222">OFFICE SYSTEM LOGIN</h6>
        <div class="mb-2"><label class="form-label">Username</label><input type="text" id="user" class="form-control form-control-sm"></div>
        <div class="mb-3"><label class="form-label">Password</label><input type="password" id="pass" class="form-control form-control-sm"></div>
        <button class="btn btn-dark btn-sm w-100" onclick="handleLogin()">Login</button>
        <div class="text-center mt-2" style="font-size: 8px; color: #777;">Authorized Personnel Only</div>
    </div>
</div>

<div id="home-screen" style="display:none;">
    <div class="home-box">
        <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
            <h5 class="fw-bold mb-0 text-dark">CLOUD DATABASE</h5>
            <div class="d-flex align-items-center">
                <span id="welcomeUser" class="me-3 fw-bold text-primary" style="font-size: 11px;"></span>
                <input type="text" id="searchBar" class="form-control form-control-sm me-2" placeholder="Search Lot Details..." onkeyup="filterTable()" style="width: 200px; height: 31px;">
                <button class="btn btn-success btn-sm fw-bold me-1" onclick="renderListFromCloud()">üîÑ REFRESH</button>
                <button class="btn btn-primary btn-sm fw-bold me-1" onclick="createNew()">+ NEW</button>
                <button class="btn btn-outline-danger btn-sm" onclick="logout()">LOGOUT</button>
            </div>
        </div>
        <div class="table-responsive" style="max-height: 400px;">
            <table class="table table-hover table-sm border" id="mainTable">
                <thead class="table-secondary">
                    <tr><th>Date Saved</th><th>Lot Details</th><th>Prepared By</th><th>Grand Total</th><th class="text-center">Actions</th></tr>
                </thead>
                <tbody id="savedList" style="font-size:11px;"></tbody>
            </table>
        </div>
    </div>
</div>

<div class="form-container" id="printable-area">
    <div class="d-print-none mb-2 border-bottom pb-2 d-flex justify-content-between">
        <button class="btn btn-secondary btn-sm" onclick="showHome()">‚Üê BACK TO HOME</button>
        <div id="editStatus" class="badge bg-danger text-white" style="display:none; font-size:11px; padding: 8px;">MODE: OVERWRITING ROW <span id="rowDisplay"></span></div>
    </div>
    <form id="taxForm">
        <input type="hidden" id="editRowNumber"> 
        <div class="row g-2 border-bottom pb-2">
            <div class="col-2">
                <label class="form-label">Date of Computation:</label><input type="text" id="compDate" class="form-control form-control-sm head-field">
                <label class="form-label mt-1">Lot Details:</label><input type="text" id="lotDetails" class="form-control form-control-sm head-field">
                <label class="form-label mt-1">Prepared By:</label><input type="text" id="preparedBy" class="form-control form-control-sm head-field" readonly style="background:#f8f9fa;">
                <label class="form-label mt-1">Full Payment:</label><input type="text" class="form-control form-control-sm head-field">
            </div>
            <div class="col-2">
                <label class="form-label">Yr. Cover:</label><input type="text" class="form-control form-control-sm head-field">
                <label class="form-label mt-1">Requested by:</label><input type="text" class="form-control form-control-sm head-field">
                <label class="form-label mt-1">Amendment:</label><input type="text" class="form-control form-control-sm head-field">
                <label class="form-label mt-1">Adv. RPT Payment:</label><input type="number" id="advPayment" class="form-control form-control-sm" oninput="updateGrandTotal()">
            </div>
            <div class="col-2">
                <label class="form-label">Classification:</label><input type="text" class="form-control form-control-sm head-field">
                <label class="form-label mt-1">Moved In/Turn Over:</label><input type="text" class="form-control form-control-sm head-field">
                <label class="form-label mt-1">Tax Dec:</label><input type="text" class="form-control form-control-sm head-field">
                <label class="form-label mt-1">Retention:</label><input type="text" class="form-control form-control-sm head-field">
            </div>
            <div class="col-6">
                <label class="form-label">Remarks:</label>
                <textarea id="remarks" class="form-control form-control-sm remarks-area">SUBJECT FOR ADJUSTMENT -</textarea>
                <div class="mt-2 text-end d-print-none">
                    <button type="button" class="btn btn-warning btn-sm fw-bold" onclick="saveRecord()">SAVE / UPDATE CLOUD</button>
                    <button type="button" class="btn btn-primary btn-sm" onclick="window.print()">Print</button>
                    <button type="button" class="btn btn-success btn-sm" onclick="downloadPDF()">PDF</button>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mt-3 p-2 bg-light border border-dark">
            <h6 class="mb-0 fw-bold">LAND COMPUTATION</h6>
            <div class="d-flex align-items-center"><span class="fw-bold me-2">LAND TOTAL:</span><input type="text" id="landTotal" class="form-control section-total-header text-center" readonly value="0.00"></div>
        </div>

        <fieldset>
            <legend style="background:#5c7bd9; color:white;">YEAR WITH OR (LAND)</legend>
            <table class="table table-bordered table-sm mb-0">
                <thead><tr><th>Yr Charge</th><th>OR Date</th><th>No. Yrs</th><th>Penalty Description</th><th>OR Amount</th><th>36% Annum</th><th>Penalty Amt</th><th>Total Amount</th><th class="d-print-none"></th></tr></thead>
                <tbody id="bodyWithOrLand"></tbody>
            </table>
            <button type="button" class="btn btn-dark btn-xs mt-1 d-print-none" onclick="addRow('bodyWithOrLand')">+ Add Row</button>
        </fieldset>

        <fieldset>
            <legend>YEAR WITHOUT OR (LAND)</legend>
            <table class="table table-bordered table-sm mb-0">
                <thead><tr><th>Year Range</th><th>Assessed Value</th><th>Tax Due %</th><th>Tax Due Amt</th><th>Penalty %</th><th>Penalty Amt</th><th>Total Amount</th><th class="d-print-none"></th></tr></thead>
                <tbody id="bodyWithoutOrLand"></tbody>
            </table>
            <button type="button" class="btn btn-dark btn-xs mt-1 d-print-none" onclick="addRow('bodyWithoutOrLand')">+ Add Row</button>
        </fieldset>

        <div class="d-print-none text-center mt-3">
            <button type="button" id="toggleBuildingBtn" class="btn btn-outline-danger btn-sm fw-bold" onclick="toggleBuilding()">+ SHOW BUILDING SECTION</button>
        </div>

        <div id="buildingSection" class="building-section">
            <div class="d-flex justify-content-between align-items-center p-2 bg-light border border-danger">
                <h6 class="mb-0 fw-bold text-danger">BUILDING COMPUTATION</h6>
                <div class="d-flex align-items-center"><span class="fw-bold me-2">BUILDING TOTAL:</span><input type="text" id="buildTotal" class="form-control section-total-header text-center" readonly value="0.00"></div>
            </div>
            <fieldset>
                <legend style="background:#5c7bd9; color:white;">YEAR WITH OR (BUILDING)</legend>
                <table class="table table-bordered table-sm mb-0">
                    <thead><tr><th>Yr Charge</th><th>OR Date</th><th>No. Yrs</th><th>Penalty Description</th><th>OR Amount</th><th>36% Annum</th><th>Penalty Amt</th><th>Total Amount</th><th class="d-print-none"></th></tr></thead>
                    <tbody id="bodyWithOrBuild"></tbody>
                </table>
                <button type="button" class="btn btn-dark btn-xs mt-1 d-print-none" onclick="addRow('bodyWithOrBuild')">+ Add Row</button>
            </fieldset>
            <fieldset>
                <legend>YEAR WITHOUT OR (BUILDING)</legend>
                <table class="table table-bordered table-sm mb-0">
                    <thead><tr><th>Year Range</th><th>Assessed Value</th><th>Tax Due %</th><th>Tax Due Amt</th><th>Penalty %</th><th>Penalty Amt</th><th>Total Amount</th><th class="d-print-none"></th></tr></thead>
                    <tbody id="bodyWithoutOrBuild"></tbody>
                </table>
                <button type="button" class="btn btn-dark btn-xs mt-1 d-print-none" onclick="addRow('bodyWithoutOrBuild')">+ Add Row</button>
            </fieldset>
        </div>

        <div class="row mt-4 align-items-end">
            <div class="col-6"></div>
            <div class="col-6">
                <div class="row align-items-center">
                    <div class="col-6 text-end h6 mb-0 fw-bold">GRAND TOTAL DUE:</div>
                    <div class="col-6"><input type="text" id="grandTotal" class="form-control balance-box text-center" readonly value="0.00"></div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
// I-CHECK NA TAMA ITONG URL NA ITO MULA SA IYONG APPS SCRIPT DEPLOYMENT
const CLOUD_URL = "https://script.google.com/macros/s/AKfycbxjWCwdUid2jTgW2p43gLTd07i-3T-cTYsokJy8vhW3syxDCSfwAFESw6BmveWZ1fG7iA/exec";

// --- LOGIN SYSTEM ---
let CURRENT_USER = "";
function handleLogin() {
    const user = document.getElementById('user').value;
    const pass = document.getElementById('pass').value;

    // DITO MO DAGDAGAN ANG MGA KATRABAHO MO
    const accounts = {
        "admin": "1234",
        "laurence": "laurence2026",
        "Gil": "gil2026",
        "staff2": "office456"
    };

    if (accounts[user] && accounts[user] === pass) {
        CURRENT_USER = user.toUpperCase();
        document.getElementById('welcomeUser').innerText = "Logged in: " + CURRENT_USER;
        document.getElementById('login-overlay').style.display = 'none';
        showHome();
    } else {
        alert("Access Denied: Mali ang Username o Password.");
    }
}

function logout() { location.reload(); }
function showHome() { document.getElementById('home-screen').style.display = 'flex'; document.querySelector('.form-container').style.display = 'none'; renderListFromCloud(); }

function filterTable() {
    let input = document.getElementById("searchBar").value.toUpperCase();
    let rows = document.getElementById("savedList").getElementsByTagName("tr");
    for (let i = 0; i < rows.length; i++) {
        let lotCell = rows[i].getElementsByTagName("td")[1];
        if (lotCell) {
            let text = lotCell.textContent || lotCell.innerText;
            rows[i].style.display = text.toUpperCase().indexOf(input) > -1 ? "" : "none";
        }
    }
}

function createNew() { 
    document.getElementById('editRowNumber').value = ""; 
    document.getElementById('editStatus').style.display = "none";
    document.getElementById('taxForm').reset(); 
    
    // Auto-fill names and date
    const today = new Date();
    document.getElementById('compDate').value = `${String(today.getMonth() + 1).padStart(2, '0')}/${String(today.getDate()).padStart(2, '0')}/${today.getFullYear()}`;
    document.getElementById('preparedBy').value = CURRENT_USER; 

    ['bodyWithOrLand','bodyWithoutOrLand','bodyWithOrBuild','bodyWithoutOrBuild'].forEach(id => { document.getElementById(id).innerHTML = ""; addRow(id); }); 
    document.getElementById('buildingSection').style.display = 'none'; 
    document.getElementById('home-screen').style.display = 'none'; 
    document.querySelector('.form-container').style.display = 'block'; 
    updateGrandTotal(); 
}

async function saveRecord() {
    const lot = document.getElementById('lotDetails').value;
    const existingRow = document.getElementById('editRowNumber').value;
    if(!lot) return alert("Lot Details required!");
    
    const record = {
        existingRow: existingRow || null,
        lot: lot, 
        prep: document.getElementById('preparedBy').value, 
        total: document.getElementById('grandTotal').value,
        fullData: {
            heads: Array.from(document.querySelectorAll('.head-field')).map(i => i.value),
            adv: document.getElementById('advPayment').value,
            remarks: document.getElementById('remarks').value,
            buildVisible: document.getElementById('buildingSection').style.display === 'block',
            wLand: scrapeTable('bodyWithOrLand'), woLand: scrapeTable('bodyWithoutOrLand'),
            wBuild: scrapeTable('bodyWithOrBuild'), woBuild: scrapeTable('bodyWithoutOrBuild')
        }
    };
    
    try {
        await fetch(CLOUD_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(record) });
        alert(existingRow ? "Row #" + existingRow + " updated successfully!" : "New record saved!");
        showHome();
    } catch(e) { alert("Error connecting to Cloud."); }
}

async function renderListFromCloud() {
    const list = document.getElementById('savedList'); 
    list.innerHTML = "Fetching Cloud Database...";
    try {
        const res = await fetch(CLOUD_URL);
        const data = await res.json();
        list.innerHTML = "";
        data.forEach((row) => {
            const rowNumber = row[5]; 
            list.innerHTML += `<tr>
                <td>${new Date(row[0]).toLocaleString()}</td>
                <td><b>${row[1]}</b></td>
                <td>${row[2]}</td>
                <td class="text-success fw-bold">${row[3]}</td>
                <td class="text-center">
                    <button class="btn btn-sm btn-primary py-0 me-1" onclick='loadForEdit(${rowNumber}, ${JSON.stringify(row[4])})'>Edit</button>
                </td></tr>`;
        });
    } catch(e) { list.innerHTML = "Sync Error. Check URL."; }
}

function loadForEdit(rowNum, jsonData) {
    document.getElementById('editRowNumber').value = rowNum;
    document.getElementById('rowDisplay').innerText = "#" + rowNum;
    document.getElementById('editStatus').style.display = "block";
    
    const data = JSON.parse(jsonData);
    const heads = document.querySelectorAll('.head-field');
    data.heads.forEach((v, i) => { if(heads[i]) heads[i].value = v; });
    
    document.getElementById('advPayment').value = data.adv;
    document.getElementById('remarks').value = data.remarks;
    toggleBuilding(data.buildVisible);
    restoreTable('bodyWithOrLand', data.wLand); restoreTable('bodyWithoutOrLand', data.woLand);
    restoreTable('bodyWithOrBuild', data.wBuild); restoreTable('bodyWithoutOrBuild', data.woBuild);
    document.getElementById('home-screen').style.display = 'none';
    document.querySelector('.form-container').style.display = 'block';
    updateGrandTotal();
}

const fcy = (n) => new Intl.NumberFormat('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}).format(n);
const parseNum = (s) => parseFloat(String(s).replace(/,/g, '')) || 0;

function toggleBuilding(force) { 
    const s = document.getElementById('buildingSection'); 
    const b = document.getElementById('toggleBuildingBtn'); 
    if(force !== undefined) s.style.display = force ? 'block' : 'none'; 
    else s.style.display = (s.style.display === 'block') ? 'none' : 'block'; 
    b.innerText = (s.style.display === 'block') ? '- HIDE BUILDING SECTION' : '+ SHOW BUILDING SECTION'; 
    updateGrandTotal(); 
}

function addRow(id) {
    const div = document.createElement('table');
    const wT = `<tr><td><input type="text" class="form-control form-control-sm"></td><td><input type="text" class="form-control form-control-sm or-date" onchange="calcWithOR(this)"></td><td><input type="text" class="form-control form-control-sm w-yrs readonly-field" readonly></td><td><input type="text" class="form-control form-control-sm w-range readonly-field" readonly></td><td><input type="number" class="form-control form-control-sm w-amt" oninput="calcWithOR(this)"></td><td><input type="text" class="form-control form-control-sm w-annum readonly-field" readonly></td><td><input type="text" class="form-control form-control-sm w-p-amt readonly-field" readonly></td><td><input type="text" class="form-control form-control-sm w-total ${id.includes('Land')?'land-t-field':'build-t-field'} readonly-field" readonly value="0.00"></td><td class="d-print-none text-center"><button type="button" class="btn btn-danger btn-action" onclick="removeRow(this)">√ó</button></td></tr>`;
    const woT = `<tr><td><input type="text" class="form-control form-control-sm wo-charge" oninput="calcWithoutOR(this)"></td><td><input type="number" class="form-control form-control-sm wo-av" oninput="calcWithoutOR(this)"></td><td><input type="text" class="form-control form-control-sm wo-tax-pct" value="2%" oninput="calcWithoutOR(this)"></td><td><input type="text" class="form-control form-control-sm wo-td readonly-field" readonly></td><td><input type="text" class="form-control form-control-sm wo-p-pct readonly-field" readonly></td><td><input type="text" class="form-control form-control-sm wo-p-amt readonly-field" readonly></td><td><input type="text" class="form-control form-control-sm wo-total ${id.includes('Land')?'land-t-field':'build-t-field'} readonly-field" readonly value="0.00"></td><td class="d-print-none text-center"><button type="button" class="btn btn-danger btn-action" onclick="removeRow(this)">√ó</button></td></tr>`;
    div.innerHTML = id.includes('Without') ? woT : wT; 
    document.getElementById(id).appendChild(div.querySelector('tr'));
}

function removeRow(btn) { 
    const tbody = btn.closest('tbody'); 
    if (tbody.querySelectorAll('tr').length > 1) btn.closest('tr').remove(); 
    updateGrandTotal(); 
}

function calcWithOR(el) {
    const tr = el.closest('tr'); 
    const dateStr = tr.querySelector('.or-date').value; 
    const amount = parseNum(tr.querySelector('.w-amt').value); 
    const inputDate = new Date(dateStr);
    if (!isNaN(inputDate)) {
        const inputYear = inputDate.getFullYear(); const inputMonth = inputDate.getMonth() + 1; const inputDay = inputDate.getDate();
        if (inputYear >= 2026) { tr.querySelector('.w-yrs').value = "0.00"; tr.querySelector('.w-range').value = "2026 (No Penalty)"; tr.querySelector('.w-p-amt').value = "0.00"; tr.querySelector('.w-total').value = fcy(amount); }
        else { 
            let qNum = 1; if ((inputMonth === 3 && inputDay >= 21) || inputMonth > 3) qNum = 2; if ((inputMonth === 6 && inputDay >= 21) || inputMonth > 6) qNum = 3; if ((inputMonth === 9 && inputDay >= 21) || inputMonth > 9) qNum = 4;
            let qFrac = (qNum === 2) ? 0.25 : (qNum === 3) ? 0.50 : (qNum === 4) ? 0.75 : 0;
            let baseValue = Math.min(5, (2025 - inputYear) + 1 - qFrac); const annum = amount * 0.36; const penalty = annum * baseValue;
            tr.querySelector('.w-yrs').value = baseValue.toFixed(2); tr.querySelector('.w-range').value = `${inputYear} Q${qNum}-2025`; tr.querySelector('.w-annum').value = fcy(annum); tr.querySelector('.w-p-amt').value = fcy(penalty); tr.querySelector('.w-total').value = fcy(amount + penalty);
        }
    } updateGrandTotal();
}

function calcWithoutOR(el) {
    const tr = el.closest('tr'); const year = parseInt(tr.querySelector('.wo-charge').value); const av = parseNum(tr.querySelector('.wo-av').value); const taxRate = parseNum(tr.querySelector('.wo-tax-pct').value) / 100;
    let pPct = (year <= 2023) ? 0.72 : (year === 2024) ? 0.48 : (year === 2025) ? 0.24 : 0; const tdAmt = av * taxRate; const pAmt = tdAmt * pPct;
    tr.querySelector('.wo-p-pct').value = (pPct * 100).toFixed(0) + "%"; tr.querySelector('.wo-td').value = fcy(tdAmt); tr.querySelector('.wo-p-amt').value = fcy(pAmt); tr.querySelector('.wo-total').value = fcy(tdAmt + pAmt); updateGrandTotal();
}

function updateGrandTotal() {
    let lSum = 0, bSum = 0; document.querySelectorAll('.land-t-field').forEach(i => lSum += parseNum(i.value));
    if(document.getElementById('buildingSection').style.display === 'block') { document.querySelectorAll('.build-t-field').forEach(i => bSum += parseNum(i.value)); }
    const adv = parseNum(document.getElementById('advPayment').value); document.getElementById('landTotal').value = fcy(lSum); document.getElementById('buildTotal').value = fcy(bSum); document.getElementById('grandTotal').value = fcy((lSum + bSum) - adv);
}

function scrapeTable(id) { return Array.from(document.querySelectorAll(`#${id} tr`)).map(tr => Array.from(tr.querySelectorAll('input')).map(i => i.value)); }
function restoreTable(id, rows) { const tb = document.getElementById(id); tb.innerHTML = ""; rows.forEach(r => { addRow(id); const inputs = tb.lastElementChild.querySelectorAll('input'); r.forEach((v, i) => { if(inputs[i]) inputs[i].value = v; }); }); }

function downloadPDF() {
    const element = document.getElementById('printable-area');
    const lot = document.getElementById('lotDetails').value || "Lot";
    const prep = document.getElementById('preparedBy').value || "Name";
    const dStr = document.getElementById('compDate').value || "Date";
    const fileName = `${lot}_${prep}_${dStr}`.replace(/[^a-z0-9]/gi, '_').toUpperCase();
    html2pdf().set({ margin: 0.2, filename: fileName + '.pdf', jsPDF: { unit: 'in', format: 'letter', orientation: 'landscape' } }).from(element).save();
}
</script>
</body>
</html>