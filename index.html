<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Tax System - Professional Format</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* I-update ito para maging fixed ang size ng box */
.home-box { 
    background: #e0e0e0; 
    padding: 25px; 
    border: 1px solid #999;
    width: 85%; 
    max-width: 950px; 
    box-shadow: 4px 4px 15px rgba(0,0,0,0.3);
    display: flex;
    flex-direction: column;
    max-height: 90vh; /* Para hindi lumampas sa screen height */
}

/* Ito ang magpapagana ng scroll sa loob ng table area */
.table-responsive {
    max-height: 400px; /* Taas ng listahan bago mag-scroll */
    overflow-y: auto; 
    border: 1px solid #999;
    background: white;
}

/* Para manatiling nakikita ang table headers habang nag-scroll */
#mainTable thead th {
    position: sticky;
    top: 0;
    z-index: 10;
    background: #ccc !important;
}
        body { background-color: #d1d4d7; font-family: Arial, sans-serif; font-size: 10px; }
        #login-overlay, #home-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #d1d4d7; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-box, .home-box { background: #e0e0e0; padding: 25px; border: 1px solid #999; width: 85%; max-width: 950px; box-shadow: 4px 4px 15px rgba(0,0,0,0.3); }
        .form-container { background: #e0e0e0; padding: 10px 15px; border: 1px solid #999; margin: 5px auto; width: 99%; box-shadow: 2px 2px 10px rgba(0,0,0,0.2); display: none; }
        .form-label { font-weight: bold; font-size: 9px; text-transform: uppercase; margin-bottom: 1px; display: block; line-height: 1; }
        .form-control-sm { border-radius: 0; border: 1px solid #888; height: 22px; font-size: 10px; padding: 2px 5px; }
        .readonly-field { background-color: #f2f2f2 !important; font-weight: bold; }
        fieldset { border: 1px solid #999; padding: 8px; margin-top: 8px; background: #e9e9e9; }
        legend { width: auto; font-size: 10px; font-weight: bold; padding: 0 5px; color: #b22222; margin-bottom: 5px; float: none; }
        th { font-size: 8px; text-align: center; background: #ccc !important; border: 1px solid #999; text-transform: uppercase; padding: 4px !important; }
        td { padding: 2px !important; vertical-align: middle; }
        .section-total-header { background: #fff; border: 2px solid #333; font-weight: bold; color: #b22222; height: 28px; font-size: 13px; width: 150px; }
        .balance-box { background: #fff; border: 2px solid #28a745; color: #28a745; font-size: 16px; height: 38px; font-weight: bold; }
        .remarks-area { height: 75px !important; resize: none; font-weight: bold; color: #0b2447; background-color: #ffeb3b !important; border: 1px solid #999; }
        .building-section { display: none; border-top: 3px double #999; margin-top: 15px; padding-top: 10px; }
        .admin-panel { background: #f8f9fa; border: 2px dashed #adb5bd; padding: 10px; margin-bottom: 15px; display: none; }
        .report-summary-box { background: white; border: 1px solid #999; padding: 15px; margin-top: 10px; font-size: 12px; }
        @media print { .d-print-none, .btn, #login-overlay, #home-screen, .admin-panel { display: none !important; } .form-container { border: none !important; box-shadow: none !important; width: 100% !important; background: white !important; display: block !important; } body { background: white !important; } fieldset { background: #fff !important; } .remarks-area { background-color: #fff !important; border: 1px solid #000 !important; } }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box" style="max-width:350px;">
        <h6 class="text-center fw-bold mb-3" style="color:#b22222">RPT ACCESS</h6>
        <div class="mb-2">
            <label class="form-label">Username</label>
            <input type="text" id="loginUser" class="form-control form-control-sm"> </div>
        <div class="mb-3">
            <label class="form-label">Password</label>
            <input type="password" id="loginPass" class="form-control form-control-sm"> </div>
        <button class="btn btn-dark btn-sm w-100" onclick="handleLogin()">Login</button>
    </div>
</div>
<div id="home-screen" style="display:none;">
    <div class="home-box">
        <div id="adminPanel" class="admin-panel">
            <h6 class="fw-bold text-danger border-bottom pb-1">ADMIN REPORT GENERATOR</h6>
            <div class="row g-2 align-items-end">
                <div class="col-md-3"><label class="form-label">Start Date:</label><input type="date" id="reportStart" class="form-control form-control-sm"></div>
                <div class="col-md-3"><label class="form-label">End Date:</label><input type="date" id="reportEnd" class="form-control form-control-sm"></div>
                <div class="col-md-4">
                    <button class="btn btn-dark btn-sm fw-bold" onclick="generateSummaryReport()">GENERATE SUMMARY</button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="printReport()">PRINT REPORT</button>
                </div>
            </div>
            <div id="reportResult" class="report-summary-box" style="display:none;"><div id="reportContent"></div></div>
        </div>
        <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
            <h5 class="fw-bold mb-0 text-dark">RPT COMPUTATION DATABASE</h5>
            <div class="d-flex align-items-center">
                <span id="welcomeUser" class="me-3 fw-bold text-primary" style="font-size: 11px;"></span>
                <input type="text" id="searchBar" class="form-control form-control-sm me-2" placeholder="Search Lot..." onkeyup="filterTable()" style="width: 200px; height: 31px;">
                <button class="btn btn-success btn-sm fw-bold me-1" onclick="renderListFromCloud()">üîÑ REFRESH</button>
                <button class="btn btn-primary btn-sm fw-bold me-1" onclick="createNew()">+ NEW</button>
                <button class="btn btn-outline-danger btn-sm" onclick="logout()">LOGOUT</button>
            </div>
        </div>
        <div class="table-responsive" style="max-height: 400px;">
            <table class="table table-hover table-sm border" id="mainTable">
                <thead class="table-secondary">
                    <tr><th>Date Saved</th><th>Lot Details</th><th>Prepared By</th><th class="text-end pe-4">Grand Total</th><th class="text-center">Actions</th></tr>
                </thead>
                <tbody id="savedList" style="font-size:11px;"></tbody>
            </table>
        </div>
    </div>
</div>

<div class="form-container" id="printable-area">
    <div class="d-print-none mb-2 border-bottom pb-2 d-flex justify-content-between align-items-center">
        <button class="btn btn-secondary btn-sm" onclick="showHome()">‚Üê BACK TO LIST</button>
        <div id="editStatus" class="badge bg-danger text-white" style="display:none; font-size:11px; padding: 8px;">MODE: EDITING ROW <span id="rowDisplay"></span></div>
        <div id="saveNotification" class="badge bg-success text-white" style="display:none; font-size:11px; padding: 8px; position:absolute; top:10px; right:10px; z-index:9999;">
    ‚úî Record Saved!
</div>

        <button class="btn btn-primary btn-sm fw-bold" onclick="createNew()">+ NEW COMPUTATION</button>
    </div>

    
    <form id="taxForm">
        <input type="hidden" id="editRowNumber"> 
        <div class="row g-2 border-bottom pb-2">
            <div class="col-2">
                <label class="form-label">Date of Computation:</label><input type="text" id="compDate" class="form-control form-control-sm head-field">
                <label class="form-label mt-1">Lot Details:</label><input type="text" id="lotDetails" class="form-control form-control-sm head-field" oninput="triggerGlobalRecalc()">
                <label class="form-label mt-1">Prepared By:</label><input type="text" id="preparedBy" class="form-control form-control-sm head-field" readonly>
                <label class="form-label mt-1">Full Payment:</label><input type="text" class="form-control form-control-sm head-field">
            </div>
            <div class="col-2">
                <label class="form-label">Yr. Cover:</label><input type="text" class="form-control form-control-sm head-field">
                <label class="form-label mt-1">Requested by:</label><input type="text" class="form-control form-control-sm head-field">
                <label class="form-label mt-1">Amendment:</label><input type="text" class="form-control form-control-sm head-field">
                <label class="form-label mt-1">Adv. RPT Payment:</label><input type="text" id="advPayment" class="form-control form-control-sm" oninput="formatInputCurrency(this); updateGrandTotal();">
            </div>
            <div class="col-2">
                <label class="form-label">Brgy:</label><input type="text" class="form-control form-control-sm head-field">
                <label class="form-label mt-1">Moved In/Turn Over:</label><input type="text" class="form-control form-control-sm head-field">
                <label class="form-label mt-1">Tax Dec:</label><input type="text" class="form-control form-control-sm head-field">
                <label class="form-label mt-1">Lapse:</label><input type="text" class="form-control form-control-sm head-field">
            </div>
            <div class="col-6">
                <label class="form-label">Remarks:</label>
                <textarea id="remarks" class="form-control form-control-sm remarks-area">SUBJECT FOR ADJUSTMENT -</textarea>
                <div class="mt-2 text-end d-print-none">
                    <button type="button" id="saveBtn" class="btn btn-warning btn-sm fw-bold" onclick="saveRecord()">SAVE / UPDATE CLOUD</button>
                    <button type="button" class="btn btn-primary btn-sm" onclick="window.print()">Print</button>
                    <button type="button" class="btn btn-success btn-sm" onclick="downloadPDF()">PDF</button>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mt-3 p-2 bg-light border border-dark">
            <h6 class="mb-0 fw-bold">LAND COMPUTATION</h6>
            <div class="d-flex align-items-center"><span class="fw-bold me-2">LAND TOTAL:</span><input type="text" id="landTotal" class="form-control section-total-header text-center" readonly value="0.00"></div>
        </div>

        <fieldset>
            <legend style="background:#5c7bd9; color:white;">YEAR WITH OR (LAND)</legend>
            <table class="table table-bordered table-sm mb-0">
                <thead><tr><th>Yr Charge</th><th>OR Date</th><th>No. Yrs</th><th>Penalty Description</th><th>OR Amount</th><th>36% Annum</th><th>Penalty Amt</th><th>Total Amount</th><th class="d-print-none"></th></tr></thead>
                <tbody id="bodyWithOrLand"></tbody>
            </table>
            <button type="button" class="btn btn-dark btn-xs mt-1 d-print-none" onclick="addRow('bodyWithOrLand')">+ Add Row</button>
        </fieldset>

        <fieldset>
            <legend>YEAR WITHOUT OR (LAND)</legend>
            <table class="table table-bordered table-sm mb-0">
                <thead><tr><th>Year Range</th><th>Assessed Value</th><th>Tax Due %</th><th>Tax Due Amt</th><th>Penalty %</th><th>Penalty Amt</th><th>Total Amount</th><th class="d-print-none"></th></tr></thead>
                <tbody id="bodyWithoutOrLand"></tbody>
            </table>
            <button type="button" class="btn btn-dark btn-xs mt-1 d-print-none" onclick="addRow('bodyWithoutOrLand')">+ Add Row</button>
        </fieldset>

        <div class="d-print-none text-center mt-3">
            <button type="button" id="toggleBuildingBtn" class="btn btn-outline-danger btn-sm fw-bold" onclick="toggleBuilding()">+ SHOW BUILDING SECTION</button>
        </div>

        <div id="buildingSection" class="building-section">
            <div class="d-flex justify-content-between align-items-center p-2 bg-light border border-danger">
                <h6 class="mb-0 fw-bold text-danger">BUILDING COMPUTATION</h6>
                <div class="d-flex align-items-center"><span class="fw-bold me-2">BUILDING TOTAL:</span><input type="text" id="buildTotal" class="form-control section-total-header text-center" readonly value="0.00"></div>
            </div>
            <fieldset>
                <legend style="background:#5c7bd9; color:white;">YEAR WITH OR (BUILDING)</legend>
                <table class="table table-bordered table-sm mb-0">
                    <thead><tr><th>Yr Charge</th><th>OR Date</th><th>No. Yrs</th><th>Penalty Description</th><th>OR Amount</th><th>36% Annum</th><th>Penalty Amt</th><th>Total Amount</th><th class="d-print-none"></th></tr></thead>
                    <tbody id="bodyWithOrBuild"></tbody>
                </table>
                <button type="button" class="btn btn-dark btn-xs mt-1 d-print-none" onclick="addRow('bodyWithOrBuild')">+ Add Row</button>
            </fieldset>
            <fieldset>
                <legend>YEAR WITHOUT OR (BUILDING)</legend>
                <table class="table table-bordered table-sm mb-0">
                    <thead><tr><th>Year Range</th><th>Assessed Value</th><th>Tax Due %</th><th>Tax Due Amt</th><th>Penalty %</th><th>Penalty Amt</th><th>Total Amount</th><th class="d-print-none"></th></tr></thead>
                    <tbody id="bodyWithoutOrBuild"></tbody>
                </table>
                <button type="button" class="btn btn-dark btn-xs mt-1 d-print-none" onclick="addRow('bodyWithoutOrBuild')">+ Add Row</button>
            </fieldset>
        </div>

        <div class="row mt-4 align-items-end">
            <div class="col-6"></div>
            <div class="col-6">
                <div class="row align-items-center">
                    <div class="col-6 text-end h6 mb-0 fw-bold">GRAND TOTAL DUE:</div>
                    <div class="col-6"><input type="text" id="grandTotal" class="form-control balance-box text-center" readonly value="0.00"></div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
const CLOUD_URL = "https://script.google.com/macros/s/AKfycbxjWCwdUid2jTgW2p43gLTd07i-3T-cTYsokJy8vhW3syxDCSfwAFESw6BmveWZ1fG7iA/exec";
let CURRENT_USER = "";

const TAX_DATABASE = {"AAM": "BRANCH", "ACD": "BRANCH", "ACE": "2%", "ACL 1": "5%", "ACL 2": "3.50%", "ACM": "3%", "ACN": "2%", "ACR": "3%", "AED": "BRANCH", "AGL": "2.50%", "AMC": "3%", "AME": "2%", "AMS": "2%", "AMV": "3%", "AVA": "2.50%", "AVS": "2%", "AVT": "2%", "BBE": "3%", "BHS": "5%", "BME": "2.50%", "BPR": "2%", "BRB": "2%", "BRM": "BRANCH", "CCL": "2%", "CDB": "5%", "CDE": "3%", "CDS": "BRANCH", "CGL": "2%", "CHR": "2%", "CLB": "2%", "CLP": "NO TD", "CMD": "BRANCH", "CMS": "2%", "CPB": "2%", "CRC": "2%", "CRE": "3%", "CSG": "2%", "CTL": "2%", "CUE": "2.50%", "CVA": "2.50%", "CVB": "2.10%", "CVC": "2%", "CVF": "4%", "CVL": "2%", "CVS": "2.10%", "CVY": "2%", "DAR": "3%", "DCS": "2%", "DJR": "2%", "EAS": "2%", "EBA": "2%", "EGC": "2%", "EGE": "2.50%", "EGV": "2%", "EPV": "2%", "ERE": "2%", "ERV": "2%", "GBB": "NO TD", "GHP": "2%", "GLN": "2%", "GMB": "2%", "GMD": "2%", "GME": "2.50%", "GMI": "BRANCH", "GMN": "2%", "GMT": "2%", "GPH": "2%", "GPP": "3%", "GPS": "2%", "GPT": "2%", "GRE": "2%", "GRT": "2%", "GRV": "3%", "GTE": "2%", "GVB": "2%", "GVW": "3%", "GWB": "2.10%", "GWE": "2.50%", "GWN": "2%", "GWS": "2.50%", "HRA": "2%", "HSP": "4%", "HVI": "BRANCH", "KVH": "2.50%", "LAN": "BRANCH", "LAP": "2%", "LBT": "DON'T COU", "LCE": "BRANCH", "LHC": "2%", "LHL": "2.60%", "LMR": "2.10%", "LMV": "BRANCH", "LPR": "3%", "LRC": "2%", "LRE": "2%", "LRS": "NO TD", "LRT": "BRANCH", "LSC": "NO TD", "LVE": "2%", "LWC": "2%", "LWE": "2%", "MBD": "BRANCH", "MGS": "2%", "MIE": "5%", "MLL": "NO TD", "MMR": "2%", "MNV": "2%", "MPE": "2%", "MPG": "2%", "MPN": "2.10%", "MPS": "2%", "MRD": "BRANCH", "MRE": "2.50%", "MRP": "4%", "MRT": "2%", "MSV": "2%", "MVB": "2.10%", "MVD": "BRANCH", "MVE": "2%", "MVM": "NO TD", "MVT": "2%", "MWE": "2%", "NCB": "2%", "NHC": "BRANCH", "NPB": "NO TD", "NPC": "2.50%", "NPE": "3%", "NVI": "BRANCH", "NVM": "NO TD", "NVP": "NO TD", "NVT": "2%", "NWE": "3%", "ORD": "BRANCH", "ORE": "2%", "ORO": "5%", "OTP": "2.50%", "OVG": "2.50%", "PAE": "2%", "PAL": "2%", "PCE": "2.50%", "PDP": "2%", "PDS": "2.50%", "PGS": "2.50%", "PHB": "2.10%", "PHS": "2.50%", "PRL": "2%", "PVB": "2.50%", "PVD": "BRANCH", "PVE": "2.50%", "PVH": "2.50%", "PVR": "2%", "PVS": "2.50%", "PWE": "2.50%", "PWG": "3%", "RDC": "2%", "RIZ": "2%", "RME": "2%", "RMS": "2%", "RNW": "2.10%", "RVC": "2%", "RWT": "2%", "SBP": "3%", "SBR": "3%", "SCB": "2%", "SCD": "2%", "SCL": "2%", "SCS": "NO TD", "SFE": "2%", "SGB": "3%", "SGD": "BRANCH", "SGE": "", "SGI": "BRANCH", "SGK": "2.50%", "SGP": "NO TD", "SHE": "2.50%", "SLE": "2.50%", "SLR": "2%", "SMD": "BRANCH", "SOD": "BRANCH", "SPE": "2%", "SPL": "2%", "SSE": "2%", "SSL": "2%", "STG": "2.50%", "STR": "2%", "STT": "2%", "SVD": "BRANCH", "SVR": "3%", "TES": "2%", "TGE": "3%", "TVT": "2%", "VCH": "2.50%", "VCT": "2%", "VPE": "2.50%", "VPP": "2.50%", "VRC": "3.50%", "VTM": "BRANCH", "VVA": "2%", "VVA/2": "2%", "VVD": "BRANCH", "VVE": "2.50%", "VVL": "5%", "VVM": "5%", "VVN": "2.50%", "VVQ": "2.50%", "VVR": "2%", "VVS": "2%", "VVW": "2.50%", "VWR": "2%", "WGV": "3%", "WRI": "BRANCH", "WRM": "5%", "YSR": "2%", "W": "2%"};

function getTaxInfo(lotText) {
    const lot = lotText.trim().toUpperCase();
    for (let key in TAX_DATABASE) { if (lot.startsWith(key)) return TAX_DATABASE[key]; }
    return "2%";
}

function triggerGlobalRecalc() {
    const lotVal = document.getElementById('lotDetails').value;
    const taxRate = getTaxInfo(lotVal);
    document.querySelectorAll('.wo-tax-pct').forEach(el => { el.value = taxRate; calcWithoutOR(el); });
    updateGrandTotal();
}

const fcy = (n) => new Intl.NumberFormat('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}).format(n);
const parseNum = (s) => parseFloat(String(s).replace(/,/g, '')) || 0;

function formatInputCurrency(el) {
    let val = el.value.replace(/,/g, '');
    if(!isNaN(val) && val.length > 0) {
        let parts = val.split('.');
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        el.value = parts.join('.');
    }
}

function handleLogin() {
    const user = document.getElementById('loginUser').value.trim().toLowerCase(); // Updated ID
    const pass = document.getElementById('loginPass').value.trim(); // Updated ID
    const accounts = { "admin":"1234", "laurence":"laurence2026", "ann":"ann2026", "gil":"gil2026", "roselyn":"roselyn2026", "egi":"egi2026", "lourdes":"lourdes2026" };
    
    if (accounts[user] && accounts[user] === pass) {
        CURRENT_USER = user.toUpperCase();
        document.getElementById('welcomeUser').innerText = "User: " + CURRENT_USER;
        document.getElementById('login-overlay').style.display = 'none';
        if(user === 'admin') document.getElementById('adminPanel').style.display = 'block';
        showHome();
    } else { 
        alert("Access Denied."); 
    }
}

async function generateSummaryReport() {
    const start = new Date(document.getElementById('reportStart').value);
    const end = new Date(document.getElementById('reportEnd').value);
    end.setHours(23, 59, 59);

    if (isNaN(start) || isNaN(end)) return alert("Select Dates.");

    const res = await fetch(CLOUD_URL);
    const data = await res.json();

    const filtered = data.filter(row => {
        const d = new Date(row[0]);
        return d >= start && d <= end;
    });

    if (filtered.length === 0) return alert("No records.");

    let total = 0;

    let html = `
        <h6><b>SUMMARY REPORT</b></h6>
        <table class="table table-sm table-bordered">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Lot</th>
                    <th>Yr. Cover</th>
                    <th>User</th>
                    <th class="text-end">Amount</th>
                </tr>
            </thead>
            <tbody>
    `;

    filtered.forEach(r => {
        const amt = parseNum(r[3]);
        total += amt;

        // üîπ extract Yr. Cover safely
        let yrCover = "";
        try {
            const fd = JSON.parse(r[4]);
            yrCover = fd.heads?.[4] || "";
        } catch(e) {}

        html += `
            <tr>
                <td>${new Date(r[0]).toLocaleDateString()}</td>
                <td>${r[1]}</td>
                <td><b>${yrCover}</b></td>
                <td>${r[2]}</td>
                <td class="text-end">${fcy(amt)}</td>
            </tr>
        `;
    });

    html += `
            </tbody>
        </table>
        <b>TOTAL: ‚Ç± ${fcy(total)}</b>
    `;

    document.getElementById('reportContent').innerHTML = html;
    document.getElementById('reportResult').style.display = 'block';
}

function printReport() {
    const content = document.getElementById('reportContent').innerHTML;
    const win = window.open('', '', 'height=700,width=900');
    win.document.write('<html><head><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"></head><body style="padding:20px;">'+content+'</body></html>');
    win.document.close(); setTimeout(() => win.print(), 500);
}

function logout() { location.reload(); }
function showHome() { document.getElementById('home-screen').style.display = 'flex'; document.querySelector('.form-container').style.display = 'none'; renderListFromCloud(); }

function filterTable() {
    let input = document.getElementById("searchBar").value.toUpperCase();
    let rows = document.getElementById("savedList").getElementsByTagName("tr");
    for (let i = 0; i < rows.length; i++) {
        let lotCell = rows[i].getElementsByTagName("td")[1];
        if (lotCell) rows[i].style.display = (lotCell.textContent || lotCell.innerText).toUpperCase().indexOf(input) > -1 ? "" : "none";
    }
}

function createNew() { 
    document.getElementById('editRowNumber').value = ""; 
    document.getElementById('editStatus').style.display = "none";
    document.getElementById('taxForm').reset(); 
    const today = new Date();
    document.getElementById('compDate').value = `${String(today.getMonth() + 1).padStart(2, '0')}/${String(today.getDate()).padStart(2, '0')}/${today.getFullYear()}`;
    document.getElementById('preparedBy').value = CURRENT_USER; 
    ['bodyWithOrLand','bodyWithoutOrLand','bodyWithOrBuild','bodyWithoutOrBuild'].forEach(id => { document.getElementById(id).innerHTML = ""; addRow(id); });
    document.getElementById('buildingSection').style.display = 'none'; 
    document.getElementById('home-screen').style.display = 'none'; 
    document.querySelector('.form-container').style.display = 'block'; 
    updateGrandTotal();
}

async function renderListFromCloud() {
    const list = document.getElementById('savedList'); list.innerHTML = "Fetching...";
    try {
        const res = await fetch(CLOUD_URL); const data = await res.json();
        list.innerHTML = "";
        data.forEach((row) => {
            list.innerHTML += `<tr><td>${new Date(row[0]).toLocaleString()}</td><td><b>${row[1]}</b></td><td>${row[2]}</td><td class="text-end pe-4 fw-bold text-success">${fcy(parseNum(row[3]))}</td><td class="text-center"><button class="btn btn-sm btn-primary py-0" onclick='loadForEdit(${row[5]}, ${JSON.stringify(row[4])})'>Edit</button></td></tr>`;
        });
        return data; 
    } catch(e) { list.innerHTML = "Sync Error."; return []; }
}

function addRow(id) {
    const div = document.createElement('table');
    const wT = `<tr>
        <td><input type="text" class="form-control form-control-sm w-charge" oninput="calcWithOR(this)"></td>
        <td><input type="text" class="form-control form-control-sm or-date" onchange="calcWithOR(this)"></td>
        <td><input type="text" class="form-control form-control-sm w-yrs readonly-field" readonly></td>
        <td><input type="text" class="form-control form-control-sm w-range readonly-field" readonly></td>
        <td><input type="text" class="form-control form-control-sm w-amt" oninput="formatInputCurrency(this); calcWithOR(this)"></td>
        <td><input type="text" class="form-control form-control-sm w-annum readonly-field" readonly></td>
        <td><input type="text" class="form-control form-control-sm w-p-amt readonly-field" readonly></td>
        <td><input type="text" class="form-control form-control-sm w-total ${id.includes('Land')?'land-t-field':'build-t-field'} readonly-field" readonly value="0.00"></td>
        <td class="d-print-none text-center">
            <div class="d-flex gap-1 justify-content-center">
                <button type="button" class="btn btn-warning btn-sm py-0 px-1" title="Clear Row" onclick="clearRow(this)">C</button>
                <button type="button" class="btn btn-danger btn-sm py-0 px-1" title="Remove Row" onclick="removeRow(this)">√ó</button>
            </div>
        </td>
    </tr>`;
    const woT = `<tr>
        <td><input type="text" class="form-control form-control-sm wo-charge" oninput="calcWithoutOR(this)"></td>
        <td><input type="text" class="form-control form-control-sm wo-av" oninput="formatInputCurrency(this); calcWithoutOR(this)"></td>
        <td><input type="text" class="form-control form-control-sm wo-tax-pct readonly-field" readonly ondblclick="this.readOnly=false; this.classList.remove('readonly-field')" onblur="this.readOnly=true; this.classList.add('readonly-field')" oninput="calcWithoutOR(this)"></td>
        <td><input type="text" class="form-control form-control-sm wo-td readonly-field" readonly></td>
        <td><input type="text" class="form-control form-control-sm wo-p-pct readonly-field" readonly ondblclick="this.readOnly=false; this.classList.remove('readonly-field')" onblur="this.readOnly=true; this.classList.add('readonly-field')" oninput="calcWithoutOR(this)"></td>
        <td><input type="text" class="form-control form-control-sm wo-p-amt readonly-field" readonly></td>
        <td><input type="text" class="form-control form-control-sm wo-total ${id.includes('Land')?'land-t-field':'build-t-field'} readonly-field" readonly value="0.00"></td>
        <td class="d-print-none text-center">
            <div class="d-flex gap-1 justify-content-center">
                <button type="button" class="btn btn-warning btn-sm py-0 px-1" title="Clear Row" onclick="clearRow(this)">C</button>
                <button type="button" class="btn btn-danger btn-sm py-0 px-1" title="Remove Row" onclick="removeRow(this)">√ó</button>
            </div>
        </td>
    </tr>`;
    div.innerHTML = id.includes('Without') ? woT : wT; 
    document.getElementById(id).appendChild(div.querySelector('tr'));
    if(id.includes('Without')) {
        document.getElementById(id).lastElementChild.querySelector('.wo-tax-pct').value = getTaxInfo(document.getElementById('lotDetails').value);
    }
}

function clearRow(btn) {
    const tr = btn.closest('tr');
    tr.querySelectorAll('input:not(.readonly-field)').forEach(input => { input.value = ""; });
    const orInput = tr.querySelector('.w-charge') || tr.querySelector('.wo-charge');
    if(orInput) orInput.dispatchEvent(new Event('input'));
    updateGrandTotal();
}

function calcWithOR(el) {
    const tr = el.closest('tr'); 
    const chargeStr = tr.querySelector('.w-charge').value.trim();
    const dateStr = tr.querySelector('.or-date').value.trim();
    const rawAmt = parseNum(tr.querySelector('.w-amt').value);

    if (!dateStr || !rawAmt || isNaN(rawAmt)) {
        tr.querySelector('.w-yrs').value = "";
        tr.querySelector('.w-range').value = "";
        tr.querySelector('.w-annum').value = "";
        tr.querySelector('.w-p-amt').value = "";
        tr.querySelector('.w-total').value = "0.00";
        updateGrandTotal();
        return;
    }

    // ===== PARSE DATE =====
    const safeDateStr = dateStr.replace(/-/g, '/');
    const [month, day, year] = safeDateStr.split('/').map(Number);
    if (!month || !day || !year) return;
    const d = new Date(year, month - 1, day);
    if (isNaN(d)) return;

    // ===== QUARTER FACTOR =====
    let quarterFactor = 1.0;
    const qMatch = chargeStr.match(/\((\d)-?(\d)?\)/);
    if (qMatch) {
        const startQ = parseInt(qMatch[1]);
        const endQ = qMatch[2] ? parseInt(qMatch[2]) : startQ;
        quarterFactor = ((endQ - startQ) + 1) / 4;
    }
    const amount = rawAmt * quarterFactor;

    // ===== NO PENALTY LOGIC (Effective Dec 21, 2025 onwards) =====
    // Kasama rito ang requested mong 12-21-2026
    const noPenaltyDate = new Date(2025, 11, 21);
    if (d >= noPenaltyDate) {
        tr.querySelector('.w-yrs').value = "0.00";
        tr.querySelector('.w-range').value = "NO PENALTY";
        tr.querySelector('.w-annum').value = fcy(amount * 0.36);
        tr.querySelector('.w-p-amt').value = "0.00";
        tr.querySelector('.w-total').value = fcy(amount);
        updateGrandTotal();
        return;
    }

    // ===== DETERMINE QUARTER & FRACTION (Cut-off: 21st) =====
    let qNum = 1;
    let qFrac = 0.00;

    if (month > 9 || (month === 9 && day >= 21)) {
        qNum = 4;
        qFrac = 0.75;
    } else if (month > 6 || (month === 6 && day >= 21)) {
        qNum = 3;
        qFrac = 0.50;
    } else if (month > 3 || (month === 3 && day >= 21)) {
        qNum = 2;
        qFrac = 0.25;
    } else {
        qNum = 1;
        qFrac = 0.00;
    }

    // ===== FINAL YEARS & DESCRIPTION LOGIC =====
    let finalYears = 0;
    let rangeLabel = "";

    // 1. Case para sa 2020 pababa (Fixed 1.00)
    if (d <= new Date(2020, 11, 20)) {
        finalYears = 1.00;
        rangeLabel = `${year}-2025`;
    } 
    // 2. Case para sa Brackets (Dec 21, 2020 hanggang Dec 20, 2025)
    else {
        let isDec21Cutoff = (month === 12 && day >= 21);
        let effectiveYear = isDec21Cutoff ? year + 1 : year;
        
        // Base points para sa brackets
        let base = 0;
        if (effectiveYear === 2021) base = 5;
        else if (effectiveYear === 2022) base = 4;
        else if (effectiveYear === 2023) base = 3;
        else if (effectiveYear === 2024) base = 2;
        else if (effectiveYear === 2025) base = 1;

        // Kung saktong Dec 21, ibigay ang flat base value (e.g., 12-21-2023 = 2)
        if (isDec21Cutoff) {
            finalYears = base; 
        } else {
            finalYears = Math.max(0, base - qFrac);
        }

        rangeLabel = `${year} Q${qNum}-2025`;
    }

    // ===== COMPUTATION =====
    const annum = amount * 0.36;
    const penalty = annum * finalYears;

    // ===== ASSIGN VALUES =====
    tr.querySelector('.w-yrs').value = finalYears.toFixed(2);
    tr.querySelector('.w-range').value = rangeLabel;
    tr.querySelector('.w-annum').value = fcy(annum);
    tr.querySelector('.w-p-amt').value = fcy(penalty);
    tr.querySelector('.w-total').value = fcy(amount + penalty);

    updateGrandTotal();
}

function calcWithoutOR(el) {
    const tr = el.closest('tr');
    const rangeInput = tr.querySelector('.wo-charge').value.trim(); 
    const av = parseNum(tr.querySelector('.wo-av').value);
    const taxRate = (parseFloat(tr.querySelector('.wo-tax-pct').value.replace('%','')) || 0) / 100;

    let multiplier = 1, quarterCount = 4, year = parseInt(rangeInput);

    if (rangeInput.includes('-') && !rangeInput.includes('(')) {
        const years = rangeInput.split('-');
        multiplier = (parseInt(years[1]) - parseInt(years[0])) + 1;
    }

    if (rangeInput.includes('(')) {
        const m = rangeInput.match(/\((\d)-?(\d)?\)/);
        if (m) quarterCount = (parseInt(m[2] || m[1]) - parseInt(m[1])) + 1;
    }

    const tdAmt = ((av * taxRate) * multiplier / 4) * quarterCount;

    /* ===== PENALTY % FIX (AUTO vs MANUAL) ===== */
    const pPctField = tr.querySelector('.wo-p-pct');
    let pPct;

    if (el === pPctField) {
        // üëà MANUAL EDIT
        pPct = parseFloat(pPctField.value.replace('%','')) / 100 || 0;
    } else {
        // üëà AUTO COMPUTATION
        pPct = (year <= 2023) ? 0.72 :
               (year === 2024) ? 0.48 :
               (year === 2025) ? 0.24 : 0;

        pPctField.value = (pPct * 100).toFixed(0) + "%";
    }
    /* ===== END FIX ===== */

    const pAmt = tdAmt * pPct;

    tr.querySelector('.wo-td').value = fcy(tdAmt);
    tr.querySelector('.wo-p-amt').value = fcy(pAmt);
    tr.querySelector('.wo-total').value = fcy(tdAmt + pAmt);

    updateGrandTotal();
}

function updateGrandTotal() {
    let lSum = 0, bSum = 0;
    document.querySelectorAll('.land-t-field').forEach(i => lSum += parseNum(i.value));
    if(document.getElementById('buildingSection').style.display === 'block') { document.querySelectorAll('.build-t-field').forEach(i => bSum += parseNum(i.value)); }
    const adv = parseNum(document.getElementById('advPayment').value);
    document.getElementById('landTotal').value = fcy(lSum);
    document.getElementById('buildTotal').value = fcy(bSum);
    document.getElementById('grandTotal').value = fcy((lSum + bSum) - adv);
}

async function saveRecord() {
    const lot = document.getElementById('lotDetails').value.trim(); // 
    const existingRow = document.getElementById('editRowNumber').value; // 
    
    if(!lot) return alert("Lot Details required!"); // 
    
    const saveBtn = document.getElementById('saveBtn'); // 
    saveBtn.disabled = true;
    saveBtn.innerText = "CHECKING DUPLICATES...";

    try {
        // 1. Kumuha muna ng latest data mula sa Cloud para i-check kung may duplicate 
        const res = await fetch(CLOUD_URL);
        const cloudData = await res.json();

        // 2. I-check kung may kaparehong Lot Details sa existing records 
        // Hahayaan lang ang pag-save kung "Edit Mode" at ang kapareho ay ang mismong row na ine-edit 
        const isDuplicate = cloudData.some(row => 
            row[1].toString().toUpperCase() === lot.toUpperCase() && 
            row[5].toString() !== existingRow.toString()
        );

        if (isDuplicate) {
            alert("Error: Ang Lot Details na '" + lot + "' ay may record na sa system. Hindi ito pwedeng i-save.");
            saveBtn.disabled = false;
            saveBtn.innerText = "SAVE / UPDATE CLOUD";
            return; // Itigil ang buong function dito 
        }

        // 3. Kung walang duplicate, ituloy ang normal na pag-save 
        saveBtn.innerText = "SAVING...";
        const record = {
            existingRow: existingRow || null, // 
            lot: lot, 
            prep: document.getElementById('preparedBy').value, // 
            total: document.getElementById('grandTotal').value, // 
            fullData: { 
                heads: Array.from(document.querySelectorAll('.head-field')).map(i => i.value), // 
                adv: document.getElementById('advPayment').value, // 
                remarks: document.getElementById('remarks').value, // 
                buildVisible: document.getElementById('buildingSection').style.display === 'block', // 
                wLand: scrapeTable('bodyWithOrLand'), // 
                woLand: scrapeTable('bodyWithoutOrLand'), // 
                wBuild: scrapeTable('bodyWithOrBuild'), // 
                woBuild: scrapeTable('bodyWithoutOrBuild') // 
            }
        };

        // I-save ang record sa Google Sheets 
        await fetch(CLOUD_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(record) }); // 
        
        // Refresh ang table list 
        const updatedData = await renderListFromCloud(); // 
        
        if(!existingRow) {
            // I-set sa Edit Mode ang bagong save na record 
            const myLatest = updatedData.filter(r => r[2] === CURRENT_USER).sort((a,b) => b[5] - a[5])[0]; // 
            if(myLatest) {
                document.getElementById('editRowNumber').value = myLatest[5]; // 
                document.getElementById('rowDisplay').innerText = myLatest[5]; // 
                document.getElementById('editStatus').style.display = "block"; // 
            }
        }
        
        alert("Success! Record saved."); // 
    } catch(e) { 
        alert("Error saving data or checking duplicates."); // 
    } finally {
        saveBtn.disabled = false; // 
        saveBtn.innerText = "SAVE / UPDATE CLOUD"; // 
    }
}



function loadForEdit(rowNum, jsonData) {
    document.getElementById('editRowNumber').value = rowNum;
    document.getElementById('rowDisplay').innerText = rowNum;
    document.getElementById('editStatus').style.display = "block";
    const data = JSON.parse(jsonData);
    const heads = document.querySelectorAll('.head-field');
    data.heads.forEach((v, i) => { if(heads[i]) heads[i].value = v; });
    document.getElementById('advPayment').value = data.adv;
    document.getElementById('remarks').value = data.remarks;
    toggleBuilding(data.buildVisible);
    restoreTable('bodyWithOrLand', data.wLand); restoreTable('bodyWithoutOrLand', data.woLand);
    restoreTable('bodyWithOrBuild', data.wBuild); restoreTable('bodyWithoutOrBuild', data.woBuild);
    document.getElementById('home-screen').style.display = 'none';
    document.querySelector('.form-container').style.display = 'block';
    updateGrandTotal();
}

function toggleBuilding(force) { 
    const s = document.getElementById('buildingSection'); 
    const b = document.getElementById('toggleBuildingBtn');
    s.style.display = (force !== undefined) ? (force ? 'block':'none') : (s.style.display==='block'?'none':'block');
    b.innerText = (s.style.display === 'block') ? '- HIDE BUILDING SECTION' : '+ SHOW BUILDING SECTION'; 
    updateGrandTotal(); 
}

function removeRow(btn) { if (btn.closest('tbody').querySelectorAll('tr').length > 1) btn.closest('tr').remove(); updateGrandTotal(); }
function scrapeTable(id) { return Array.from(document.querySelectorAll(`#${id} tr`)).map(tr => Array.from(tr.querySelectorAll('input')).map(i => i.value)); }
function restoreTable(id, rows) { 
    const tb = document.getElementById(id); tb.innerHTML = "";
    rows.forEach(r => { addRow(id); const inputs = tb.lastElementChild.querySelectorAll('input'); r.forEach((v, i) => { if(inputs[i]) inputs[i].value = v; }); });
}

function downloadPDF() {
    const element = document.getElementById('printable-area');
    const lot = document.getElementById('lotDetails').value || "LOT";
    const prep = document.getElementById('preparedBy').value || "PREP";
    const date = document.getElementById('compDate').value.replace(/\//g, '-') || "DATE";
    const finalFileName = `${lot}_${prep}_${date}.pdf`;
    const opt = { margin: [0.3, 0.3, 0.3, 0.3], filename: finalFileName, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } };
    html2pdf().set(opt).from(element).save();
}
</script>
</body>
</html>

