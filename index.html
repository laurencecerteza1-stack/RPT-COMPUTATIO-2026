<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Tax System - Professional Format</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { background-color: #d1d4d7; font-family: Arial, sans-serif; font-size: 10px; }
        #login-overlay, #home-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #d1d4d7; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-box, .home-box { background: #e0e0e0; padding: 25px; border: 1px solid #999; width: 85%; max-width: 950px; box-shadow: 4px 4px 15px rgba(0,0,0,0.3); }
        .form-container { background: #e0e0e0; padding: 10px 15px; border: 1px solid #999; margin: 5px auto; width: 99%; box-shadow: 2px 2px 10px rgba(0,0,0,0.2); display: none; }
        .form-label { font-weight: bold; font-size: 9px; text-transform: uppercase; margin-bottom: 1px; display: block; line-height: 1; }
        .form-control-sm { border-radius: 0; border: 1px solid #888; height: 22px; font-size: 10px; padding: 2px 5px; }
        .readonly-field { background-color: #f2f2f2 !important; font-weight: bold; }
        fieldset { border: 1px solid #999; padding: 8px; margin-top: 8px; background: #e9e9e9; }
        legend { width: auto; font-size: 10px; font-weight: bold; padding: 0 5px; color: #b22222; margin-bottom: 5px; float: none; }
        th { font-size: 8px; text-align: center; background: #ccc !important; border: 1px solid #999; text-transform: uppercase; padding: 4px !important; }
        td { padding: 2px !important; vertical-align: middle; }
        .section-total-header { background: #fff; border: 2px solid #333; font-weight: bold; color: #b22222; height: 28px; font-size: 13px; width: 150px; }
        .balance-box { background: #fff; border: 2px solid #28a745; color: #28a745; font-size: 16px; height: 38px; font-weight: bold; }
        .remarks-area { height: 75px !important; resize: none; font-weight: bold; color: #0b2447; background-color: #ffeb3b !important; border: 1px solid #999; }
        .building-section { display: none; border-top: 3px double #999; margin-top: 15px; padding-top: 10px; }
        @media print { .d-print-none, .btn, #login-overlay, #home-screen { display: none !important; } .form-container { border: none; box-shadow: none; width: 100%; background: white !important; display: block !important; } }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box" style="max-width:350px;">
        <h6 class="text-center fw-bold mb-3" style="color:#b22222">SYSTEM ACCESS</h6>
        <div class="mb-2"><label class="form-label">Username</label><input type="text" id="user" class="form-control form-control-sm"></div>
        <div class="mb-3"><label class="form-label">Password</label><input type="password" id="pass" class="form-control form-control-sm"></div>
        <button class="btn btn-dark btn-sm w-100" onclick="handleLogin()">Login</button>
    </div>
</div>

<div id="home-screen" style="display:none;">
    <div class="home-box">
        <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
            <h5 class="fw-bold mb-0 text-dark">CLOUD DATABASE</h5>
            <div class="d-flex align-items-center">
                <span id="welcomeUser" class="me-3 fw-bold text-primary" style="font-size: 11px;"></span>
                <input type="text" id="searchBar" class="form-control form-control-sm me-2" placeholder="Search Lot..." onkeyup="filterTable()" style="width: 200px; height: 31px;">
                <button class="btn btn-success btn-sm fw-bold me-1" onclick="renderListFromCloud()">üîÑ REFRESH</button>
                <button class="btn btn-primary btn-sm fw-bold me-1" onclick="createNew()">+ NEW</button>
                <button class="btn btn-outline-danger btn-sm" onclick="logout()">LOGOUT</button>
            </div>
        </div>
        <div class="table-responsive" style="max-height: 400px;">
            <table class="table table-hover table-sm border" id="mainTable">
                <thead class="table-secondary">
                    <tr><th>Date Saved</th><th>Lot Details</th><th>Prepared By</th><th class="text-end pe-4">Grand Total</th><th class="text-center">Actions</th></tr>
                </thead>
                <tbody id="savedList" style="font-size:11px;"></tbody>
            </table>
        </div>
    </div>
</div>

<div class="form-container" id="printable-area">
    <div class="d-print-none mb-2 border-bottom pb-2 d-flex justify-content-between">
        <button class="btn btn-secondary btn-sm" onclick="showHome()">‚Üê BACK TO HOME</button>
        <div id="editStatus" class="badge bg-danger text-white" style="display:none; font-size:11px; padding: 8px;">MODE: EDITING ROW <span id="rowDisplay"></span></div>
    </div>
    <form id="taxForm">
        <input type="hidden" id="editRowNumber"> 
        <div class="row g-2 border-bottom pb-2">
            <div class="col-2">
                <label class="form-label">Date of Computation:</label><input type="text" id="compDate" class="form-control form-control-sm head-field">
                <label class="form-label mt-1">Lot Details:</label><input type="text" id="lotDetails" class="form-control form-control-sm head-field" oninput="triggerGlobalRecalc()">
                <label class="form-label mt-1">Prepared By:</label><input type="text" id="preparedBy" class="form-control form-control-sm head-field" readonly>
                <label class="form-label mt-1">Full Payment:</label><input type="text" class="form-control form-control-sm head-field">
            </div>
            <div class="col-2">
                <label class="form-label">Yr. Cover:</label><input type="text" class="form-control form-control-sm head-field">
                <label class="form-label mt-1">Requested by:</label><input type="text" class="form-control form-control-sm head-field">
                <label class="form-label mt-1">Amendment:</label><input type="text" class="form-control form-control-sm head-field">
                <label class="form-label mt-1">Adv. RPT Payment:</label><input type="text" id="advPayment" class="form-control form-control-sm" oninput="formatInputCurrency(this); updateGrandTotal();">
            </div>
            <div class="col-2">
                <label class="form-label">Classification:</label><input type="text" class="form-control form-control-sm head-field">
                <label class="form-label mt-1">Moved In/Turn Over:</label><input type="text" class="form-control form-control-sm head-field">
                <label class="form-label mt-1">Tax Dec:</label><input type="text" class="form-control form-control-sm head-field">
                <label class="form-label mt-1">Retention:</label><input type="text" class="form-control form-control-sm head-field">
            </div>
            <div class="col-6">
                <label class="form-label">Remarks:</label>
                <textarea id="remarks" class="form-control form-control-sm remarks-area">SUBJECT FOR ADJUSTMENT -</textarea>
                <div class="mt-2 text-end d-print-none">
                    <button type="button" class="btn btn-warning btn-sm fw-bold" onclick="saveRecord()">SAVE / UPDATE CLOUD</button>
                    <button type="button" class="btn btn-primary btn-sm" onclick="window.print()">Print</button>
                    <button type="button" class="btn btn-success btn-sm" onclick="downloadPDF()">PDF</button>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mt-3 p-2 bg-light border border-dark">
            <h6 class="mb-0 fw-bold">LAND COMPUTATION</h6>
            <div class="d-flex align-items-center"><span class="fw-bold me-2">LAND TOTAL:</span><input type="text" id="landTotal" class="form-control section-total-header text-center" readonly value="0.00"></div>
        </div>

        <fieldset>
            <legend style="background:#5c7bd9; color:white;">YEAR WITH OR (LAND)</legend>
            <table class="table table-bordered table-sm mb-0">
                <thead><tr><th>Yr Charge</th><th>OR Date</th><th>No. Yrs</th><th>Penalty Description</th><th>OR Amount</th><th>36% Annum</th><th>Penalty Amt</th><th>Total Amount</th><th class="d-print-none"></th></tr></thead>
                <tbody id="bodyWithOrLand"></tbody>
            </table>
            <button type="button" class="btn btn-dark btn-xs mt-1 d-print-none" onclick="addRow('bodyWithOrLand')">+ Add Row</button>
        </fieldset>

        <fieldset>
            <legend>YEAR WITHOUT OR (LAND)</legend>
            <table class="table table-bordered table-sm mb-0">
                <thead><tr><th>Year Range</th><th>Assessed Value</th><th>Tax Due %</th><th>Tax Due Amt</th><th>Penalty %</th><th>Penalty Amt</th><th>Total Amount</th><th class="d-print-none"></th></tr></thead>
                <tbody id="bodyWithoutOrLand"></tbody>
            </table>
            <button type="button" class="btn btn-dark btn-xs mt-1 d-print-none" onclick="addRow('bodyWithoutOrLand')">+ Add Row</button>
        </fieldset>

        <div class="d-print-none text-center mt-3">
            <button type="button" id="toggleBuildingBtn" class="btn btn-outline-danger btn-sm fw-bold" onclick="toggleBuilding()">+ SHOW BUILDING SECTION</button>
        </div>

        <div id="buildingSection" class="building-section">
            <div class="d-flex justify-content-between align-items-center p-2 bg-light border border-danger">
                <h6 class="mb-0 fw-bold text-danger">BUILDING COMPUTATION</h6>
                <div class="d-flex align-items-center"><span class="fw-bold me-2">BUILDING TOTAL:</span><input type="text" id="buildTotal" class="form-control section-total-header text-center" readonly value="0.00"></div>
            </div>
            <fieldset>
                <legend style="background:#5c7bd9; color:white;">YEAR WITH OR (BUILDING)</legend>
                <table class="table table-bordered table-sm mb-0">
                    <thead><tr><th>Yr Charge</th><th>OR Date</th><th>No. Yrs</th><th>Penalty Description</th><th>OR Amount</th><th>36% Annum</th><th>Penalty Amt</th><th>Total Amount</th><th class="d-print-none"></th></tr></thead>
                    <tbody id="bodyWithOrBuild"></tbody>
                </table>
                <button type="button" class="btn btn-dark btn-xs mt-1 d-print-none" onclick="addRow('bodyWithOrBuild')">+ Add Row</button>
            </fieldset>
            <fieldset>
                <legend>YEAR WITHOUT OR (BUILDING)</legend>
                <table class="table table-bordered table-sm mb-0">
                    <thead><tr><th>Year Range</th><th>Assessed Value</th><th>Tax Due %</th><th>Tax Due Amt</th><th>Penalty %</th><th>Penalty Amt</th><th>Total Amount</th><th class="d-print-none"></th></tr></thead>
                    <tbody id="bodyWithoutOrBuild"></tbody>
                </table>
                <button type="button" class="btn btn-dark btn-xs mt-1 d-print-none" onclick="addRow('bodyWithoutOrBuild')">+ Add Row</button>
            </fieldset>
        </div>

        <div class="row mt-4 align-items-end">
            <div class="col-6"></div>
            <div class="col-6">
                <div class="row align-items-center">
                    <div class="col-6 text-end h6 mb-0 fw-bold">GRAND TOTAL DUE:</div>
                    <div class="col-6"><input type="text" id="grandTotal" class="form-control balance-box text-center" readonly value="0.00"></div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
const CLOUD_URL = "https://script.google.com/macros/s/AKfycbxjWCwdUid2jTgW2p43gLTd07i-3T-cTYsokJy8vhW3syxDCSfwAFESw6BmveWZ1fG7iA/exec";
let CURRENT_USER = "";

// TAX RATE LOOKUP TABLE (Base sa iyong image)
const TAX_RATES = {
    "ACE": 2, "ACL 1": 5, "ACL 2": 3.5, "ACM": 3, "ACN": 2, "ACR": 3, "AGL": 2.5, "AMC": 3, "AME": 2, "AMS": 2, "AMV": 3, "AVA": 2.5, "AVS": 2, "AVT": 2, "BBE": 3, "BHS": 5, "BME": 2.5, "BPR": 2, "BRB": 2, "CDB": 5, "CDE": 3, "CGL": 2, "CHR": 2, "CLB": 2, "CMS": 2, "CPB": 2, "CRC": 2, "CRE": 3, "CSG": 2, "CTL": 2, "CUE": 2.5, "CVA": 2.5, "CVB": 2.10, "CVC": 2, "CVF": 4, "CVL": 2, "CVS": 2.10, "CVY": 2, "DAR": 3, "DCS": 2, "DJR": 2, "EAS": 2, "EBA": 2, "EGC": 2, "EGE": 2.5, "EGV": 2, "EPV": 2, "ERE": 2, "ERV": 2, "GHP": 2, "GLN": 2, "GMB": 2, "GMD": 2, "GME": 2.5, "GMN": 2, "GMT": 2, "GPH": 2, "GPP": 3, "GPS": 2, "GPT": 2, "GRE": 2, "GRT": 2, "GRV": 3, "GTE": 2, "GVB": 2, "GVW": 3, "GWB": 2.10, "GWE": 2.5, "GWN": 2, "GWS": 2.5, "HRA": 2, "HSP": 4, "KVH": 2.5, "LAP": 2, "LHC": 2, "LHL": 2.6, "LMR": 2.10, "LPR": 3, "LRC": 2, "LRE": 2, "LVE": 2, "LWC": 2, "LWE": 2, "MGS": 2, "MIE": 5, "MMR": 2, "MNV": 2, "MPE": 2, "MPG": 2, "MPN": 2.10, "MPS": 2, "MRE": 2.5, "MRP": 4, "MRT": 2, "MSV": 2, "MVB": 2.10, "MVE": 2, "MVT": 2, "MWE": 2, "NCB": 2, "NPC": 2.5, "NPE": 3, "NVT": 2, "NWE": 3, "ORE": 2, "ORO": 5, "OTP": 2.5, "OVG": 2.5, "PAE": 2, "PAL": 2, "PCE": 2.5, "PDP": 2, "PDS": 2.5, "PGS": 2.5, "PHB": 2.10, "PHS": 2.5, "PRL": 2, "PVB": 2.5, "PVE": 2.5, "PVH": 2.5, "PVR": 2, "PVS": 2.5, "PWE": 2.5, "PWG": 3, "RDC": 2, "RIZ": 2, "RME": 2, "RMS": 2, "RNW": 2.10, "RVC": 2, "RWT": 2, "SBP": 3, "SBR": 3, "SCB": 2, "SCD": 2, "SCL": 2, "SFE": 2, "SGB": 3, "SHE": 2.5, "SLE": 2.5, "SLR": 2, "SPE": 2, "SPL": 2, "SSE": 2, "SSL": 2, "STG": 2.5, "STR": 2, "STT": 2, "SVR": 3, "TES": 2, "TGE": 3, "TVT": 2, "TVT": 2, "VCH": 2, "VCT": 2, "VPE": 2.5, "VPP": 2.5, "VRC": 3.5, "VVA": 2, "VVA/2": 2, "VVE": 2.5, "VVL": 5, "VVM": 5, "VVN": 2.5, "VVQ": 2.5, "VVR": 2, "VVS": 2, "VVW": 2.5, "VWR": 2, "WGV": 3, "WRM": 5, "YSR": 2, "W": 2
};

function getRateFromLot(lotText) {
    const lot = lotText.trim().toUpperCase();
    for (let code in TAX_RATES) {
        if (lot.startsWith(code)) return TAX_RATES[code];
    }
    return 2; // Default 2%
}

function triggerGlobalRecalc() {
    document.querySelectorAll('.wo-charge').forEach(el => calcWithoutOR(el));
    updateGrandTotal();
}

const fcy = (n) => new Intl.NumberFormat('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}).format(n);
const parseNum = (s) => parseFloat(String(s).replace(/,/g, '')) || 0;

function formatInputCurrency(el) {
    let val = el.value.replace(/,/g, '');
    if(!isNaN(val) && val.length > 0) {
        let parts = val.split('.');
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        el.value = parts.join('.');
    }
}

function handleLogin() {
    const user = document.getElementById('user').value.trim().toLowerCase();
    const pass = document.getElementById('pass').value.trim();
    const accounts = { "admin":"1234", "laurence":"laurence2026", "ann":"ann2026", "gil":"gil2026", "roselyn":"roselyn2026", "egi":"egi2026", "lourdes":"lourdes2026" };
    if (accounts[user] && accounts[user] === pass) {
        CURRENT_USER = user.toUpperCase();
        document.getElementById('welcomeUser').innerText = "User: " + CURRENT_USER;
        document.getElementById('login-overlay').style.display = 'none';
        showHome();
    } else { alert("Access Denied."); }
}

function logout() { location.reload(); }
function showHome() { document.getElementById('home-screen').style.display = 'flex'; document.querySelector('.form-container').style.display = 'none'; renderListFromCloud(); }

function filterTable() {
    let input = document.getElementById("searchBar").value.toUpperCase();
    let rows = document.getElementById("savedList").getElementsByTagName("tr");
    for (let i = 0; i < rows.length; i++) {
        let lotCell = rows[i].getElementsByTagName("td")[1];
        if (lotCell) rows[i].style.display = (lotCell.textContent || lotCell.innerText).toUpperCase().indexOf(input) > -1 ? "" : "none";
    }
}

function createNew() { 
    document.getElementById('editRowNumber').value = ""; 
    document.getElementById('editStatus').style.display = "none";
    document.getElementById('taxForm').reset(); 
    const today = new Date();
    document.getElementById('compDate').value = `${String(today.getMonth() + 1).padStart(2, '0')}/${String(today.getDate()).padStart(2, '0')}/${today.getFullYear()}`;
    document.getElementById('preparedBy').value = CURRENT_USER; 
    ['bodyWithOrLand','bodyWithoutOrLand','bodyWithOrBuild','bodyWithoutOrBuild'].forEach(id => { document.getElementById(id).innerHTML = ""; addRow(id); }); 
    document.getElementById('buildingSection').style.display = 'none'; 
    document.getElementById('home-screen').style.display = 'none'; 
    document.querySelector('.form-container').style.display = 'block'; 
    updateGrandTotal(); 
}

async function renderListFromCloud() {
    const list = document.getElementById('savedList'); 
    list.innerHTML = "Fetching...";
    try {
        const res = await fetch(CLOUD_URL);
        const data = await res.json();
        list.innerHTML = "";
        data.forEach((row) => {
            const rowNumber = row[5];
            const formattedTotal = fcy(parseNum(row[3])); 
            list.innerHTML += `<tr>
                <td>${new Date(row[0]).toLocaleString()}</td>
                <td><b>${row[1]}</b></td>
                <td>${row[2]}</td>
                <td class="text-end pe-4 fw-bold text-success">${formattedTotal}</td>
                <td class="text-center"><button class="btn btn-sm btn-primary py-0" onclick='loadForEdit(${rowNumber}, ${JSON.stringify(row[4])})'>Edit</button></td>
            </tr>`;
        });
    } catch(e) { list.innerHTML = "Sync Error."; }
}

function addRow(id) {
    const div = document.createElement('table');
    const wT = `<tr>
        <td><input type="text" class="form-control form-control-sm w-charge" oninput="calcWithOR(this)"></td>
        <td><input type="text" class="form-control form-control-sm or-date" onchange="calcWithOR(this)"></td>
        <td><input type="text" class="form-control form-control-sm w-yrs readonly-field" readonly></td>
        <td><input type="text" class="form-control form-control-sm w-range readonly-field" readonly></td>
        <td><input type="text" class="form-control form-control-sm w-amt" oninput="formatInputCurrency(this); calcWithOR(this)"></td>
        <td><input type="text" class="form-control form-control-sm w-annum readonly-field" readonly></td>
        <td><input type="text" class="form-control form-control-sm w-p-amt readonly-field" readonly></td>
        <td><input type="text" class="form-control form-control-sm w-total ${id.includes('Land')?'land-t-field':'build-t-field'} readonly-field" readonly value="0.00"></td>
        <td class="d-print-none text-center"><button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)">√ó</button></td>
    </tr>`;
    const woT = `<tr>
        <td><input type="text" class="form-control form-control-sm wo-charge" oninput="calcWithoutOR(this)"></td>
        <td><input type="text" class="form-control form-control-sm wo-av" oninput="formatInputCurrency(this); calcWithoutOR(this)"></td>
        <td><input type="text" class="form-control form-control-sm wo-tax-pct readonly-field" readonly></td>
        <td><input type="text" class="form-control form-control-sm wo-td readonly-field" readonly></td>
        <td><input type="text" class="form-control form-control-sm wo-p-pct readonly-field" readonly></td>
        <td><input type="text" class="form-control form-control-sm wo-p-amt readonly-field" readonly></td>
        <td><input type="text" class="form-control form-control-sm wo-total ${id.includes('Land')?'land-t-field':'build-t-field'} readonly-field" readonly value="0.00"></td>
        <td class="d-print-none text-center"><button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)">√ó</button></td>
    </tr>`;
    div.innerHTML = id.includes('Without') ? woT : wT; 
    document.getElementById(id).appendChild(div.querySelector('tr'));
    if(id.includes('Without')) triggerGlobalRecalc();
}

function calcWithOR(el) {
    const tr = el.closest('tr'); 
    const chargeStr = tr.querySelector('.w-charge').value;
    const dateStr = tr.querySelector('.or-date').value; 
    const rawAmt = parseNum(tr.querySelector('.w-amt').value); 
    const inputDate = new Date(dateStr);

    let quarterFactor = 1.0;
    if(chargeStr.includes('(')) {
        const qMatch = chargeStr.match(/\((\d)-?(\d)?\)/);
        if(qMatch) {
            const startQ = parseInt(qMatch[1]);
            const endQ = qMatch[2] ? parseInt(qMatch[2]) : startQ;
            quarterFactor = ((endQ - startQ) + 1) / 4;
        }
    }
    const amount = rawAmt * quarterFactor;

    if (!isNaN(inputDate)) {
        const inputYear = inputDate.getFullYear(); const inputMonth = inputDate.getMonth() + 1; const inputDay = inputDate.getDate();
        if (inputYear >= 2026) { 
            tr.querySelector('.w-yrs').value = "0.00"; 
            tr.querySelector('.w-range').value = "2026 (No Penalty)"; 
            tr.querySelector('.w-p-amt').value = "0.00"; 
            tr.querySelector('.w-total').value = fcy(amount); 
        } else { 
            let qNum = 1; if ((inputMonth === 3 && inputDay >= 21) || inputMonth > 3) qNum = 2; if ((inputMonth === 6 && inputDay >= 21) || inputMonth > 6) qNum = 3; if ((inputMonth === 9 && inputDay >= 21) || inputMonth > 9) qNum = 4;
            let qFrac = (qNum === 2) ? 0.25 : (qNum === 3) ? 0.50 : (qNum === 4) ? 0.75 : 0;
            let baseValue = Math.min(5, (2025 - inputYear) + 1 - qFrac); 
            const annum = amount * 0.36; const penalty = annum * baseValue;
            tr.querySelector('.w-yrs').value = baseValue.toFixed(2); 
            tr.querySelector('.w-range').value = `${inputYear} Q${qNum}-2025`; 
            tr.querySelector('.w-annum').value = fcy(annum); 
            tr.querySelector('.w-p-amt').value = fcy(penalty); 
            tr.querySelector('.w-total').value = fcy(amount + penalty);
        }
    } updateGrandTotal();
}

function calcWithoutOR(el) {
    const tr = el.closest('tr');
    const rangeInput = tr.querySelector('.wo-charge').value.trim(); 
    const av = parseNum(tr.querySelector('.wo-av').value);
    
    // DYNAMIC TAX RATE
    const lotDetails = document.getElementById('lotDetails').value;
    const rateValue = getRateFromLot(lotDetails);
    tr.querySelector('.wo-tax-pct').value = rateValue + "%";
    const taxRate = rateValue / 100;

    let multiplier = 1; let quarterCount = 4; 
    let year = parseInt(rangeInput);

    if (rangeInput.includes('-') && !rangeInput.includes('(')) {
        const years = rangeInput.split('-');
        const sY = parseInt(years[0]), eY = parseInt(years[1]);
        if (!isNaN(sY) && !isNaN(eY) && eY <= 2023) multiplier = (eY - sY) + 1;
    }

    if (rangeInput.includes('(')) {
        const matches = rangeInput.match(/\((\d)-?(\d)?\)/);
        if (matches) {
            const sQ = parseInt(matches[1]), eQ = matches[2] ? parseInt(matches[2]) : sQ;
            quarterCount = (eQ - sQ) + 1;
        }
    }

    const tdAmt = ((av * taxRate) * multiplier / 4) * quarterCount;
    let pPct = (year <= 2023) ? 0.72 : (year === 2024) ? 0.48 : (year === 2025) ? 0.24 : 0;
    const pAmt = tdAmt * pPct;

    tr.querySelector('.wo-p-pct').value = (pPct * 100).toFixed(0) + "%";
    tr.querySelector('.wo-td').value = fcy(tdAmt);
    tr.querySelector('.wo-p-amt').value = fcy(pAmt);
    tr.querySelector('.wo-total').value = fcy(tdAmt + pAmt);
    updateGrandTotal();
}

function updateGrandTotal() {
    let lSum = 0, bSum = 0; 
    document.querySelectorAll('.land-t-field').forEach(i => lSum += parseNum(i.value));
    if(document.getElementById('buildingSection').style.display === 'block') {
        document.querySelectorAll('.build-t-field').forEach(i => bSum += parseNum(i.value));
    }
    const adv = parseNum(document.getElementById('advPayment').value);
    document.getElementById('landTotal').value = fcy(lSum);
    document.getElementById('buildTotal').value = fcy(bSum);
    document.getElementById('grandTotal').value = fcy((lSum + bSum) - adv);
}

async function saveRecord() {
    const lot = document.getElementById('lotDetails').value;
    const existingRow = document.getElementById('editRowNumber').value;
    if(!lot) return alert("Lot Details required!");
    const record = {
        existingRow: existingRow || null,
        lot: lot, prep: document.getElementById('preparedBy').value, total: document.getElementById('grandTotal').value,
        fullData: { 
            heads: Array.from(document.querySelectorAll('.head-field')).map(i => i.value),
            adv: document.getElementById('advPayment').value,
            remarks: document.getElementById('remarks').value,
            buildVisible: document.getElementById('buildingSection').style.display === 'block',
            wLand: scrapeTable('bodyWithOrLand'), woLand: scrapeTable('bodyWithoutOrLand'),
            wBuild: scrapeTable('bodyWithOrBuild'), woBuild: scrapeTable('bodyWithoutOrBuild')
        }
    };
    try {
        await fetch(CLOUD_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(record) });
        alert("Success!"); showHome();
    } catch(e) { alert("Error."); }
}

function loadForEdit(rowNum, jsonData) {
    document.getElementById('editRowNumber').value = rowNum;
    document.getElementById('editStatus').style.display = "block";
    const data = JSON.parse(jsonData);
    const heads = document.querySelectorAll('.head-field');
    data.heads.forEach((v, i) => { if(heads[i]) heads[i].value = v; });
    document.getElementById('advPayment').value = data.adv;
    document.getElementById('remarks').value = data.remarks;
    toggleBuilding(data.buildVisible);
    restoreTable('bodyWithOrLand', data.wLand); restoreTable('bodyWithoutOrLand', data.woLand);
    restoreTable('bodyWithOrBuild', data.wBuild); restoreTable('bodyWithoutOrBuild', data.woBuild);
    document.getElementById('home-screen').style.display = 'none';
    document.querySelector('.form-container').style.display = 'block';
    updateGrandTotal();
}

function toggleBuilding(force) { 
    const s = document.getElementById('buildingSection'); 
    const b = document.getElementById('toggleBuildingBtn'); 
    s.style.display = (force !== undefined) ? (force ? 'block':'none') : (s.style.display==='block'?'none':'block');
    b.innerText = (s.style.display === 'block') ? '- HIDE BUILDING SECTION' : '+ SHOW BUILDING SECTION'; 
    updateGrandTotal(); 
}

function removeRow(btn) { if (btn.closest('tbody').querySelectorAll('tr').length > 1) btn.closest('tr').remove(); updateGrandTotal(); }
function scrapeTable(id) { return Array.from(document.querySelectorAll(`#${id} tr`)).map(tr => Array.from(tr.querySelectorAll('input')).map(i => i.value)); }
function restoreTable(id, rows) { const tb = document.getElementById(id); tb.innerHTML = ""; rows.forEach(r => { addRow(id); const inputs = tb.lastElementChild.querySelectorAll('input'); r.forEach((v, i) => { if(inputs[i]) inputs[i].value = v; }); }); }

function downloadPDF() {
    const element = document.getElementById('printable-area');
    const lot = document.getElementById('lotDetails').value;
    const prep = document.getElementById('preparedBy').value;
    const date = document.getElementById('compDate').value;
    const rawFileName = lot + "_" + prep + "_" + date;
    const finalFileName = rawFileName.replace(/[\\/:*?"<>|]/g, '');
    const opt = {
        margin: 0.2,
        filename: finalFileName + '.pdf',
        image: { type: 'jpeg', quality: 1.0 },
        html2canvas: { scale: 4, useCORS: true, dpi: 300, letterRendering: true },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'landscape', compress: true }
    };
    html2pdf().set(opt).from(element).save();
}
</script>
</body>
</html>
